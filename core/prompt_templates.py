from typing import List, Dict, Any

STORY_PLANNING_PROMPT_TEMPLATE = """
<s>[INST] 您是一位專精於寶可夢世界的故事大師。
您的任務是根據使用者的輸入，為短篇寶可夢故事創建一個重要且連貫的計劃或大綱。
在創建計劃時，請使用**繁體中文**，並確保語言風格和詞彙盡可能接近**台灣常用風格**。
確保計劃符合指定的**故事類型：{genre}**。
如果使用者希望包含寶可夢能力（見下方「包含寶可夢能力」），請確保計劃允許有效展示這些能力的時刻。

使用者輸入：
- 故事主題：{theme}
- 故事類型：{genre}
- 涉及的寶可夢：{pokemon_names}
- 故事概要/想法：{synopsis}
- 包含寶可夢能力：{include_abilities}

請生成一個結構化的故事計劃。與其列出許多小點，請著重於**3到5個主要部分或階段**，代表故事進展的重要部分。例如：

*   **設定 / 開端：** 介紹主要角色、初始場景，以及主要衝突開始前的普通世界。
*   **對抗 / 上升行動：** 描述主要衝突或問題、面臨的挑戰，以及如何提高賭注。此部分可能涵蓋幾個關鍵事件以建立緊張感。
*   **高潮 / 轉折點：** 故事中最激烈的部分，衝突達到頂峰。
*   **結局 / 餘波：** 衝突如何解決，以及角色之後的情況。展示新的常態。

如果故事的流程建議不同的自然分段（例如，謎團可能有「發現」、「調查」、「揭露」），請隨意調整這些部分名稱或結構。
**計劃中的每個部分應總結故事進展的重要部分，而不僅僅是一個事件。**

確保計劃連貫、有創意，並忠於寶可夢世界的精神（例如，友誼、冒險、訓練、探索等主題）。
計劃應足夠詳細，以指導撰寫約1500-2000字的短篇故事，每個計劃部分應足夠豐富，可以擴展為幾段或幾頁文字。
專注於使故事引人入勝，並自然地將指定的寶可夢融入敘事中。

僅輸出故事計劃。暫時不要撰寫完整故事。 [/INST] 故事計劃："""

STORY_GENERATION_FROM_PLAN_PROMPT_TEMPLATE = """
<s>[INST] 您是一位專精於寶可夢世界的故事大師。
我將提供您之前生成的故事計劃。
您的任務是根據此計劃撰寫一個完整、引人入勝且結構良好的短篇寶可夢故事（約1000-1500字，但如果需要更多字數以使故事完整且引人入勝，請隨意撰寫）。
請使用**繁體中文**，並確保語言風格、詞彙和措辭盡可能接近**台灣常用風格**。
故事應強烈反映指定的**故事類型：{genre}**。

故事計劃：
{story_plan}

使用者的原始輸入（作為背景，確保這些在故事中有所反映）：
- 故事主題：{theme}
- 故事類型：{genre}
- 涉及的寶可夢：{pokemon_names}
- 故事概要/想法：{synopsis}
- 包含寶可夢能力：{include_abilities}

撰寫指南：
-   **語言風格**：故事**必須以繁體中文撰寫，並符合台灣常用措辭和詞彙（台灣常用風格）**。
-   **類型遵循**：故事必須符合指定的**故事類型：{genre}**。例如，如果類型是「喜劇」，請確保有幽默元素。如果是「科幻」，請融入未來或科技方面的內容。
-   **詳細擴展每個計劃點**：對於提供的故事計劃中的每個部分（例如，介紹、激發事件、上升行動、高潮、下降行動、結局），您必須**大幅擴展**。這意味著：
    *   **描述性語言**：使用生動的描述來描繪場景、角色的外貌、情感和行動。
    *   **展示而非陳述**：與其陳述事實，不如描述場景和互動以揭示這些事實。
    *   **角色思想和對話**：包括主要角色（寶可夢或人類）的內心獨白，以及角色之間有意義的對話，以推進情節並揭示個性。如果寶可夢無法說人類語言，請描述牠們的表情、聲音和行動，以傳達牠們的感受和意圖。
    *   **感官細節**：調動多種感官（視覺、聽覺、嗅覺、觸覺、味覺，如適用）以使場景更具沉浸感。
    *   **部分內的節奏**：確保每個擴展部分都有良好的流動性，並對整體敘事弧線有所貢獻。
-   **寶可夢能力整合（如果「包含寶可夢能力」為是）**：如果使用者要求，自然地將涉及的寶可夢的已知能力、特徵或獨特特性融入敘事中。例如，如果涉及皮卡丘且其能力是靜電，對手可能在接觸時麻痺。如果某寶可夢以速度著稱，請生動描述其快速動作。展示，而非僅僅陳述，這些能力的作用。
-   **敘事風格**：以清晰、描述性且引人入勝的敘事風格撰寫，適合寶可夢冒險故事，並根據指定類型進行調整。
-   **角色塑造**：簡要通過行動和對話（如有）使寶可夢和任何人類角色（如果暗示或可以推斷）栩栩如生。
-   **寶可夢元素**：自然地整合寶可夢能力、戰鬥（如果適合計劃），以及寶可夢世界的整體氛圍。
-   **節奏**：確保故事從計劃的一部分流暢地過渡到下一部分，並且整體故事感覺內容充實。
-   **字數和深度**：目標故事長度約為**1000-1500字，或更長以充分展開計劃中的情節點**。目標是豐富、詳細的敘事，而非僅僅摘要。不要急於完成故事；需要多少空間就用多少空間來講述故事。
-   **完整性**：故事應有明確的開端、中間和結尾，遵循提供的計劃並擴展其內容。
-   **語氣**：保持與使用者主題一致的語氣，以及寶可夢的整體積極精神，除非主題明確表明另有要求（例如，謎團故事可能有更懸疑的語氣）。

現在撰寫完整故事。僅輸出故事。不要包含任何其他評論。 [/INST] 寶可夢故事："""


INPUT_REFINEMENT_SUGGESTION_PROMPT_TEMPLATE = """
<s>[INST] 您是一個寶可夢故事生成器的有用 AI 助手。
使用者提供了一些初步輸入，但可以更詳細以幫助創建更豐富的故事。
根據他們目前的輸入，提供1-2個有幫助且簡潔的建議或問題，以鼓勵他們添加更多細節。
請使用**繁體中文**，並使用**台灣常用措辭和詞彙（台灣常用風格）**。

使用者目前的輸入：
- 故事主題：{theme}
- 故事類型：{genre}
- 涉及的寶可夢：{pokemon_names}
- 故事概要/想法：{synopsis}
- 包含寶可夢能力：{include_abilities}

針對**{genre}**故事的良好建議示例：
- "您能否多說一些提到的主要寶可夢（{pokemon_names_for_suggestion_context}）的性格特徵？"
- "涉及的寶可夢彼此或與任何訓練師之間有什麼樣的關係？"
- "您想像這個故事發生在哪個特定地區或環境類型（例如，茂密的森林、繁忙的城市、寧靜的湖畔）？"
- "您想像角色在這個故事中的主要挑戰或目標是什麼？"

您的建議應措辭禮貌且易於使用者採納。
專注於顯著增強故事深度或獨特性的方面。
僅提供建議，無需額外的對話性內容。 [/INST] 建議："""


AGENT_CLARIFICATION_PROMPT_TEMPLATE = """
<s>[INST] 您是一位 AI 寶可夢故事共同創作者。您目前正在幫助使用者撰寫故事。
根據目前已開發的故事和使用者的初始請求，您已確定某個點需要使用者提供更多細節，以幫助您繼續撰寫或使故事的某部分更好。

使用者的初始請求：
- 故事主題：{theme}
- 故事類型：{genre}
- 涉及的寶可夢：{pokemon_names} 
- 故事概要/想法：{synopsis}

目前已開發的故事：
{current_story_context}

您的目標：向使用者提出一個簡潔、針對性的問題，以獲得有助於您繼續撰寫精彩故事的具體信息。問題應感覺自然且具有合作性。
如果某個特定寶可夢與您的問題相關，請使用 {relevant_pokemon_name} 來提及它。

示例問題：
- "為了使即將到來的寶可夢對戰更精彩，您希望 {relevant_pokemon_name} 使用什麼特殊招式？"
- "故事正朝著一個發現的方向發展。您想像他們會找到什麼樣的古代遺跡或隱藏地點？"
- "在他們到達水晶洞穴之前，是否應該在低語森林中遇到某個特定障礙或友好角色？"

請清楚且直接地措辭您的問題。 [/INST] 使用者問題："""


STORY_PLAN_REVIEW_REVISE_PROMPT_TEMPLATE = """\
<s>[INST] 您是一位專業的寶可夢故事計劃編輯。
您的任務是根據使用者的原始請求和特定標準審查生成的故事計劃。
如果計劃已經非常出色，請說明。如果需要改進，請提供建設性反饋和修訂後的故事計劃。
請使用**繁體中文**，並使用**台灣常用措辭和詞彙（台灣常用風格）**進行所有輸出。

使用者的原始輸入：
- 故事主題：{theme}
- 故事類型：{genre}
- 涉及的寶可夢：{pokemon_names}
- 故事概要/想法：{synopsis}
- 包含寶可夢能力：{include_abilities}

生成的故事計劃以供審查：
{story_plan_to_review}

審查標準：
1.  **連貫性和邏輯性**：計劃是否內部一致且合乎邏輯？各部分是否流暢？
2.  **與使用者輸入的對齊**：計劃是否準確反映使用者的主題、類型、寶可夢和概要？
3.  **寶可夢精神**：計劃是否捕捉到寶可夢世界的精髓（友誼、冒險、探索等）？寶可夢是否自然融入？
4.  **創意和吸引力**：計劃是否原創且有趣？是否承諾一個引人入勝的故事？
5.  **結構和細節**：計劃是否結構良好（例如，3-5個主要部分）？每部分是否有足夠的細節以指導撰寫約1000-1500字的故事？
6.  **類型適切性**：計劃是否符合指定的故事類型：{genre}？
7.  **能力整合（如適用）**：如果「包含寶可夢能力」為是，計劃是否創造了展示它們的機會？

輸出格式：
請分兩部分提供您的回應：
1.  **評估回饋：**以此確切短語開頭。簡要總結您的發現（1-3句）。
2.  **修訂後故事大綱：**以此確切短語開頭。提供完整的修訂後故事計劃。如果不需要修訂且原計劃非常出色，您可以在此重新陳述原計劃或說明「原故事大綱已達標，無需修訂。」。

良好輸出結構示例：
評估回饋：此計畫在創意方面表現出色，但第二部分的邏輯稍有欠缺，且未充分利用 {pokemon_names} 的特性。
修訂後故事大綱：
*   第一部分：[修訂後的第一部分內容]
*   第二部分：[修訂後的第二部分內容，解決了邏輯問題並加入特性展現]
*   ... (依此類推)

現在審查提供的故事計劃。
[/INST]
"""

FULL_STORY_REVIEW_REVISE_PROMPT_TEMPLATE = """\
<s>[INST] 您是一位一絲不苟的寶可夢故事編輯。
您的任務是根據使用者的原始請求、指導故事計劃和特定質量標準審查並改進生成的完整故事。
請使用**繁體中文**，並使用**台灣常用措辭和詞彙（台灣常用風格）**進行所有輸出。

使用者的原始輸入：
- 故事主題：{theme}
- 故事類型：{genre}
- 涉及的寶可夢：{pokemon_names}
- 故事概要/想法：{synopsis}
- 包含寶可夢能力：{include_abilities}

指導故事計劃：
{story_plan}

生成的完整故事以供審查：
{full_story_to_review}

審查標準：
1.  **遵循計劃**：故事是否忠實遵循並擴展提供的指導故事計劃？
2.  **吸引力和節奏**：故事是否引人入勝？節奏是否適合類型和字數？
3.  **語言和風格**：故事是否以流利的繁體中文（台灣風格）撰寫？描述性語言是否生動？是否「展示」多於「陳述」？
4.  **類型一致性**：故事是否強烈反映指定的故事類型：{genre}？
5.  **角色塑造**：寶可夢（以及任何人類角色）是否通過行動、思想和對話有效地描繪？
6.  **寶可夢整合**：寶可夢能力、特徵和世界氛圍是否自然且正確地整合？（參考 {pokemon_names} 和 {include_abilities}）
7.  **連貫性和清晰性**：敘事是否清晰、合乎邏輯且易於理解？
8.  **完整性和字數**：故事是否感覺完整（開端、中間、結尾）？字數是否約在1000-1500字範圍內或適當更長以滿足需要？
9.  **情感影響（如適用）**：故事是否根據其主題和類型引發預期的情感？

請輸出改進後的完整故事。如果原故事已經非常出色無需修訂，您可以直接重新輸出原故事。
請僅輸出故事內容，不要包含任何評估回饋、標題或額外說明。

現在審查並輸出改進後的完整故事。
[/INST]
"""

SYNOPSIS_ELABORATION_PROMPT_TEMPLATE = """\
<s>[INST] 您是一位寶可夢故事創意腦力激盪夥伴。
根據使用者的初步主題和概要（可能較簡略），您的任務是提出3-4個不同且引人入勝的擴展或替代方向。每個擴展應提供獨特的角度、潛在衝突或有趣的子情節。
請使用**繁體中文**，並使用**台灣常用措辭和詞彙（台灣常用風格）**。

使用者的初步輸入：
- 故事主題：{theme}
- 故事類型：{genre}
- 涉及的寶可夢：{pokemon_names}
- 故事概要/想法：{synopsis}

任務：提供3-4個編號的擴展。每個擴展應為簡潔段落。
專注於創意、遵循寶可夢世界，以及具有吸引力的故事潛力。

良好輸出格式示例：
1.  **方向一：[標題]** - [詳細闡述第一種可能性，例如強調某個寶可夢的秘密，或引入一個意外的外部因素...]
2.  **方向二：[標題]** - [詳細闡述第二種可能性，例如轉變故事的核心衝突，或探索一個不同的情感主題...]
3.  **方向三：[標題]** - [詳細闡述第三種可能性，例如聚焦於寶可夢之間的關係發展，或設定一個更宏大的背景...]

[/INST]
擴展的故事概要選項："""

CHARACTER_DEVELOPMENT_PROMPT_TEMPLATE = """\
<s>[INST] 您是一位寶可夢角色分析師和傳記作者。
根據主要寶可夢、故事主題、類型和概要，您的任務是為每個關鍵寶可夢創建更豐富的角色檔案。此檔案應有助於撰寫更引人入勝的故事。
請使用**繁體中文**，並使用**台灣常用措辭和詞彙（台灣常用風格）**。

使用者的輸入：
- 故事主題：{theme}
- 故事類型：{genre}
- 涉及的寶可夢：{pokemon_names}（逗號分隔，例如：皮卡丘, 伊布）
- 故事概要/想法：{synopsis}
- 可選的現有故事計劃（作為背景）：{story_plan}

對於「涉及的寶可夢」中的每個寶可夢（最多3個以簡潔為限，如果列出很多，請專注於前幾個）：
-   **名稱：** [寶可夢中文名]
-   **性格特點：** [描述其主要性格，例如：勇敢但魯莽、聰明但多疑、害羞卻善良等。]
-   **核心動機：** [在這個故事背景下，牠最渴望達成什麼？例如：保護夥伴、證明自己、尋找真相、渴望歸屬感等。]
-   **潛在內心衝突：** [牠可能面臨的內心掙扎或兩難，例如：忠誠與個人慾望的衝突、恐懼與責任的拉扯。]
-   **與其他角色可能的關係：** [簡述牠與故事中其他指定寶可夢或潛在人類角色的關係基調，例如：競爭對手、摯友、導師、被保護者。]
-   **一句代表性的內心獨白（可選）：** [一句能展現其當下心境或個性的話。]

清楚地逐一輸出檔案。
[/INST]
詳細的寶可夢角色檔案："""

SETTING_DETAIL_PROMPT_TEMPLATE = """\
<s>[INST] 您是一位寶可夢世界建造者和場景設計師。
根據使用者的故事主題、類型和概要，您的任務是詳細描述一個關鍵的潛在場景。這將有助於使讀者沉浸於故事中。
請使用**繁體中文**，並使用**台灣常用措辭和詞彙（台灣常用風格）**。

使用者的輸入：
- 故事主題：{theme}
- 故事類型：{genre}
- 故事概要/想法：{synopsis}
- 可選的現有故事計劃（作為背景）：{story_plan}

任務：描述故事中暗示或適合的一個關鍵場景。考慮以下方面：
-   **設定名稱（可自創）：** 例如：迷霧森林的深處、廢棄發電廠的秘密實驗室、星晶洞穴的閃爍之心。
-   **整體氛圍：** 描述這個地方給人的感覺（例如：神秘、詭譎、寧靜、莊嚴、破敗、生機勃勃）。
-   **視覺細節：** 有哪些顯著的景觀、建築、植被、光影效果？
-   **聽覺/嗅覺/觸覺細節（若適用）：** 這個地方有哪些獨特的聲音、氣味或體感？
-   **與故事的關聯性：** 這個設定如何與主題、概要或潛在情節產生連結？它可能帶來什麼樣的機遇或挑戰？
-   **潛在的寶可夢棲息地：** 哪些類型的寶可夢可能生活在這裡（與使用者指定的寶可夢無關，純粹是環境描述）？

提供一段（或幾段）描述性文字來描繪場景。
[/INST]
詳細的場景描述："""

PLOT_TWIST_SUGGESTION_PROMPT_TEMPLATE = """\
<s>[INST] 您是一位寶可夢故事情節轉折大師。
根據故事計劃（或其中的特定部分），您的任務是提出2-3個引人入勝且出乎意料的情節轉折，這些轉折可以使故事更精彩或更深刻。
請使用**繁體中文**，並使用**台灣常用措辭和詞彙（台灣常用風格）**。

指導故事計劃：
{story_plan}

可選：專注於計劃中的特定部分以進行轉折（如果為空，請考慮整體計劃或高潮的轉折）：
{section_to_twist}

任務：提供2-3個編號的情節轉折建議。每個建議應簡潔並解釋其如何改變故事的方向或意義。
專注於巧妙、符合寶可夢世界且大致與主題和類型一致的轉折（除非轉折是*關於*顛覆類型）。

良好輸出格式示例：
1.  **驚天逆轉：[標題]** - [詳細闡述轉折點。例如：原以為的盟友其實是幕後黑手，目標是利用主角的寶可夢完成某個古老的儀式...]
2.  **意想不到的援手：[標題]** - [詳細闡述轉折點。例如：在主角群陷入絕境時，一個之前看似微不足道或敵對的角色/寶可夢突然出現，並提供了關鍵的幫助，其動機令人意外...]
3.  **真相的另一面：[標題]** - [詳細闡述轉折點。例如：主角一直追尋的目標或認定的事實，其實有著不為人知的另一面，這個發現顛覆了主角的認知...]

[/INST]
情節轉折建議："""

STYLE_TONE_TUNING_PROMPT_TEMPLATE = """\
<s>[INST] 您是一位專精於寶可夢敘事的文學風格模擬器。
您的任務是重寫給定的寶可夢故事文本，以匹配新的期望風格或語氣，同時保留核心事件和角色。
請使用**繁體中文**，並使用**台灣常用措辭和詞彙（台灣常用風格）**進行重寫。

原始故事文本（或片段）：
{story_text_to_tune}

原始故事背景（供參考）：
- 故事主題：{theme}
- 故事類型：{genre}

期望的新風格/語氣：{desired_style_tone}（例如，「更加懸疑緊張」、「更幽默詼諧」、「更具史詩感」、「更溫馨感人」、「以小智的口吻來旁白」）

任務：根據期望的新風格/語氣重寫提供的故事文本。確保保留原始文本中的主要情節點。
專注於詞彙選擇、句子結構、節奏和描述性語言以實現目標風格/語氣。

[/INST]
重寫的故事文本（以{desired_style_tone}風格/語氣）："""

STORY_BRANCHING_SUGGESTION_PROMPT_TEMPLATE = """\
<s>[INST] 您是一位寶可夢故事導航員。
根據故事的當前片段，您的任務是提出2-3個不同且合理的下一場景或發展，代表故事可能採取的不同選擇或路徑。
請使用**繁體中文**，並使用**台灣常用措辭和詞彙（台灣常用風格）**。

當前故事片段：
{current_story_segment}

原始故事背景（供參考）：
- 故事主題：{theme}
- 故事類型：{genre}
- 可選的指導故事計劃：{story_plan}

任務：提供2-3個編號的*下一個*場景或短事件序列的建議。每個建議應為描述可能接下來發生的事情的段落。
這些分支應感覺像自然的延續，但提供結果或重點上的有意義差異。

良好輸出格式示例：
1.  **選項一：[簡短標題]** - [描述第一種可能的後續發展，例如：主角決定直接面對挑戰，導致一場激烈的寶可夢對戰...]
2.  **選項二：[簡短標題]** - [描述第二種可能的後續發展，例如：主角選擇尋找盟友，引發一段探索或社交互動的劇情...]
3.  **選項三：[簡短標題]** - [描述第三種可能的後續發展，例如：一個意外的發現改變了當前的局勢，迫使主角重新評估計畫...]

[/INST]
建議的故事分支："""


def format_prompt(template: str, **kwargs: Any) -> str:
    try:
        return template.format(**kwargs)
    except KeyError as e:
        missing_key = str(e)
        raise KeyError(
            f"提示範本中的佔位符 {missing_key} 未提供。"
            f"可用佔位符：範本中的 {{...}}。提供的 kwargs：{list(kwargs.keys())}"
        ) from e